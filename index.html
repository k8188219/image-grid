<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Images</title>
  <script src="./utils.js"></script>
  <style>
    #drop {
      min-height: 100vh;
    }

    body {
      overflow: scroll;
      margin: 0;
    }

    .image-row {
      display: flex;
      height: auto;
    }
  </style>
</head>

<body>
  <!-- <input type="file" multiple /> -->
  <!-- <div id="drop"></div> -->
  <div id="tag"></div>
  <script>
    var list = [
      // "https://picsum.photos/300/400",
      // "https://picsum.photos/400/300",
      // "https://picsum.photos/320/180",
      // "https://picsum.photos/180/320",
    ]

    // var input = document.querySelector("input");
    // input.onchange = async function (e) {
    //   for (let file of input.files)
    //     list.push(await getSrc(file));
    //   input.remove();
    //   main(list);
    // }

    async function main(list) {
      var tag = document.querySelector("#tag");
      tag.innerHTML = `<div class="image-row"></div>`;
      var row = document.body.insertBefore(tag.firstChild, tag);
      var targetWidth = row.offsetWidth;
      var widthSum = 0

      var image_promises = list.map(src => getImage(src));

      var fragment = document.createDocumentFragment();

      for (var promise of image_promises) {
        var img = await promise;
        if (!img) continue
        img.style.width = "0px"
        img.style.flexGrow = img.naturalWidth / img.naturalHeight
        widthSum += img.naturalWidth / img.naturalHeight * 150;

        if (widthSum <= targetWidth)
          fragment.appendChild(img);
        if (widthSum > targetWidth) {
          row.appendChild(fragment);

          tag.innerHTML = `<div class="image-row"></div>`;
          row = document.body.insertBefore(tag.firstChild, tag);
          fragment = document.createDocumentFragment();
          fragment.appendChild(img);
          widthSum = img.naturalWidth / img.naturalHeight * 150;
        }
      }
      row.appendChild(fragment);
    }

  </script>
  <script>
    window.addEventListener("dragover", (event) => event.preventDefault());
    window.addEventListener("drop", handleDrop);

    function handleDrop(event) {
      // drop.remove()
      document.querySelectorAll(".image-row").forEach(ele => ele.remove())
      event.stopPropagation();
      event.preventDefault();
      debugger
      var fileTreePromise = [...event.dataTransfer.items]
        .filter(item => item.kind === "file")
        .map(item => item.webkitGetAsEntry())
        .map(entry => traverseFileTree(entry))

      Promise.all(fileTreePromise).then(trees => {
        main(trees.flat().map(e => getSrc(e.file)));
      });
      return;
    }
  </script>
</body>

</html>